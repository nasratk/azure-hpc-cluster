{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "location": {
        "type": "string",
        "defaultValue": "UK South",
        "metadata": {
          "description": "Location for the resources."
        }
      },
      "resourceGroupName": {
        "type": "string",
        "defaultValue": "hpc-uk-01",
        "metadata": {
          "description": "Name of the new resource group for the HPC cluster."
        }
      },
      "domainJoinUsername": {
        "type": "string",
        "metadata": {
          "description": "Domain join username with permissions to join computers to the domain."
        }
      },
      "domainJoinPassword": {
        "type": "securestring",
        "metadata": {
          "description": "Password for the domain join username."
        }
      },
      "subnetName": {
        "type": "string",
        "metadata": {
          "description": "The name of the existing subnet where the cluster nodes will be deployed."
        }
      },
      "vnetName": {
        "type": "string",
        "metadata": {
          "description": "The name of the existing VNet where the subnet is located."
        }
      },
      "headNodePrefix": {
        "type": "string",
        "defaultValue": "hn-01-",
        "metadata": {
          "description": "Prefix for the head node names."
        }
      },
      "computeNodePrefix": {
        "type": "string",
        "defaultValue": "cn-01-",
        "metadata": {
          "description": "Prefix for compute node names."
        }
      },
      "headNodeVmSize": {
        "type": "string",
        "defaultValue": "Standard_D8s_v3",
        "metadata": {
          "description": "VM size for the head node."
        }
      },
      "computeNodeVmSize": {
        "type": "string",
        "defaultValue": "Standard_D4s_v3",
        "metadata": {
          "description": "VM size for the compute nodes."
        }
      },
      "computeNodeCount": {
        "type": "int",
        "defaultValue": 4,
        "metadata": {
          "description": "Number of compute nodes."
        }
      },
      "adminUsername": {
        "type": "string",
        "metadata": {
          "description": "Administrator username for the virtual machines."
        }
      },
      "adminPassword": {
        "type": "securestring",
        "metadata": {
          "description": "Administrator password for the virtual machines."
        }
      }
    },
    "resources": [
      {
        "type": "Microsoft.Resources/resourceGroups",
        "apiVersion": "2021-04-01",
        "name": "[parameters('resourceGroupName')]",
        "location": "[parameters('location')]",
        "properties": {}
      },
      {
        "type": "Microsoft.Compute/virtualMachines",
        "apiVersion": "2023-03-01",
        "name": "[concat(parameters('headNodePrefix'), '00')]",
        "location": "[parameters('location')]",
        "dependsOn": [
          "[resourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
        ],
        "properties": {
          "hardwareProfile": {
            "vmSize": "[parameters('headNodeVmSize')]"
          },
          "osProfile": {
            "computerName": "[concat(parameters('headNodePrefix'), '00')]",
            "adminUsername": "[parameters('adminUsername')]",
            "adminPassword": "[parameters('adminPassword')]"
          },
          "networkProfile": {
            "networkInterfaces": [
              {
                "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('headNodePrefix'), '00', '-nic'))]"
              }
            ]
          }
        }
      },
      {
        "type": "Microsoft.Compute/virtualMachines/extensions",
        "apiVersion": "2023-03-01",
        "name": "[concat(parameters('headNodePrefix'), '00', '/joindomain')]",
        "location": "[parameters('location')]",
        "dependsOn": [
          "[resourceId('Microsoft.Compute/virtualMachines', concat(parameters('headNodePrefix'), '00'))]"
        ],
        "properties": {
          "publisher": "Microsoft.Compute",
          "type": "JsonADDomainExtension",
          "typeHandlerVersion": "1.3",
          "settings": {
            "Name": "numerica.in",
            "OUPath": "OU=HPC,DC=numerica,DC=in",
            "User": "[parameters('domainJoinUsername')]",
            "Restart": "true"
          },
          "protectedSettings": {
            "Password": "[parameters('domainJoinPassword')]"
          }
        }
      },
      {
        "type": "Microsoft.Compute/virtualMachines",
        "apiVersion": "2023-03-01",
        "name": "[concat(parameters('computeNodePrefix'), '00')]",
        "location": "[parameters('location')]",
        "properties": {
          "hardwareProfile": {
            "vmSize": "[parameters('computeNodeVmSize')]"
          },
          "osProfile": {
            "computerName": "[concat(parameters('computeNodePrefix'), '00')]",
            "adminUsername": "[parameters('adminUsername')]",
            "adminPassword": "[parameters('adminPassword')]"
          },
          "networkProfile": {
            "networkInterfaces": [
              {
                "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('computeNodePrefix'), '00', '-nic'))]"
              }
            ]
          }
        }
      },
      {
        "type": "Microsoft.Compute/virtualMachines/extensions",
        "apiVersion": "2023-03-01",
        "name": "[concat(parameters('computeNodePrefix'), '00', '/joindomain')]",
        "location": "[parameters('location')]",
        "dependsOn": [
          "[resourceId('Microsoft.Compute/virtualMachines', concat(parameters('computeNodePrefix'), '00'))]"
        ],
        "properties": {
          "publisher": "Microsoft.Compute",
          "type": "JsonADDomainExtension",
          "typeHandlerVersion": "1.3",
          "settings": {
            "Name": "numerica.in",
  